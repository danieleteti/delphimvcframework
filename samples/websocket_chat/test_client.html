<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Test Client</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        .control-panel {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .control-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        input[type="text"] {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.2s;
        }
        .btn-connect {
            background: #28a745;
            color: white;
        }
        .btn-connect:hover {
            background: #218838;
        }
        .btn-disconnect {
            background: #dc3545;
            color: white;
        }
        .btn-disconnect:hover {
            background: #c82333;
        }
        .btn-send {
            background: #007bff;
            color: white;
        }
        .btn-send:hover {
            background: #0056b3;
        }
        .btn-clear {
            background: #6c757d;
            color: white;
        }
        .status {
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-weight: bold;
        }
        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.connecting {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        #log {
            border: 1px solid #ddd;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            height: 400px;
            overflow-y: auto;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
        }
        .log-entry {
            margin: 2px 0;
            padding: 2px 0;
        }
        .log-sent {
            color: #4ec9b0;
        }
        .log-received {
            color: #ce9178;
        }
        .log-system {
            color: #608b4e;
        }
        .log-error {
            color: #f48771;
        }
        .timestamp {
            color: #858585;
            font-size: 11px;
        }
        .quick-messages {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .quick-btn {
            padding: 5px 15px;
            background: #17a2b8;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .quick-btn:hover {
            background: #138496;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîå WebSocket Test Client</h1>
        <p class="subtitle">Test your DelphiMVCFramework WebSocket server</p>

        <div class="control-panel">
            <div class="control-row">
                <input type="text" id="wsUrl" value="ws://localhost:8080/chat" placeholder="WebSocket URL">
                <button class="btn-connect" onclick="connect()">Connect</button>
                <button class="btn-disconnect" onclick="disconnect()">Disconnect</button>
            </div>

            <div class="control-row">
                <input type="text" id="username" placeholder="Username (optional)">
                <button class="btn-send" onclick="setUsername()">Set Username</button>
            </div>

            <div class="control-row">
                <input type="text" id="message" placeholder="Type a message..." onkeypress="if(event.key==='Enter') sendMessage()">
                <button class="btn-send" onclick="sendMessage()">Send</button>
            </div>

            <div class="quick-messages">
                <button class="quick-btn" onclick="sendQuick('Hello!')">üëã Hello</button>
                <button class="quick-btn" onclick="sendQuick('How are you?')">üí¨ How are you?</button>
                <button class="quick-btn" onclick="sendQuick('Test message')">üß™ Test</button>
                <button class="quick-btn" onclick="sendPing()">üì° Ping</button>
                <button class="quick-btn" onclick="sendJSON()">üìã JSON Test</button>
            </div>
        </div>

        <div id="status" class="status disconnected">
            ‚ö´ Disconnected
        </div>

        <div style="margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
            <strong>Message Log:</strong>
            <button class="btn-clear" onclick="clearLog()">Clear Log</button>
        </div>

        <div id="log"></div>
    </div>

    <script>
        let ws = null;
        let messageCount = 0;

        function log(message, type = 'system') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.innerHTML = `<span class="timestamp">[${timestamp}]</span> ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            messageCount++;
        }

        function setStatus(text, state) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = text;
            statusDiv.className = `status ${state}`;
        }

        function connect() {
            const url = document.getElementById('wsUrl').value;

            if (ws && ws.readyState === WebSocket.OPEN) {
                log('‚ö†Ô∏è Already connected', 'system');
                return;
            }

            log(`üîå Connecting to ${url}...`, 'system');
            setStatus('üü° Connecting...', 'connecting');

            try {
                ws = new WebSocket(url);

                ws.onopen = () => {
                    log('‚úÖ Connected successfully!', 'system');
                    setStatus('üü¢ Connected', 'connected');
                };

                ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        log(`üì• Received: ${JSON.stringify(data, null, 2)}`, 'received');
                    } catch (e) {
                        log(`üì• Received: ${event.data}`, 'received');
                    }
                };

                ws.onerror = (error) => {
                    log(`‚ùå WebSocket error: ${error}`, 'error');
                    console.error('WebSocket error:', error);
                };

                ws.onclose = (event) => {
                    log(`üî¥ Connection closed (Code: ${event.code}, Reason: ${event.reason || 'None'})`, 'system');
                    setStatus('‚ö´ Disconnected', 'disconnected');
                    ws = null;
                };

            } catch (error) {
                log(`‚ùå Connection failed: ${error.message}`, 'error');
                setStatus('‚ö´ Disconnected', 'disconnected');
            }
        }

        function disconnect() {
            if (ws) {
                log('üîå Disconnecting...', 'system');
                ws.close(1000, 'User requested disconnect');
                ws = null;
            } else {
                log('‚ö†Ô∏è Not connected', 'system');
            }
        }

        function sendMessage() {
            const messageInput = document.getElementById('message');
            const text = messageInput.value.trim();

            if (!text) {
                log('‚ö†Ô∏è Message is empty', 'system');
                return;
            }

            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('‚ö†Ô∏è Not connected to server', 'error');
                return;
            }

            const msg = {
                type: 'chat',
                text: text
            };

            ws.send(JSON.stringify(msg));
            log(`üì§ Sent: ${JSON.stringify(msg)}`, 'sent');
            messageInput.value = '';
        }

        function setUsername() {
            const usernameInput = document.getElementById('username');
            const username = usernameInput.value.trim();

            if (!username) {
                log('‚ö†Ô∏è Username is empty', 'system');
                return;
            }

            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('‚ö†Ô∏è Not connected to server', 'error');
                return;
            }

            const msg = {
                type: 'username',
                username: username
            };

            ws.send(JSON.stringify(msg));
            log(`üì§ Sent: ${JSON.stringify(msg)}`, 'sent');
        }

        function sendQuick(text) {
            document.getElementById('message').value = text;
            sendMessage();
        }

        function sendPing() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('‚ö†Ô∏è Not connected to server', 'error');
                return;
            }

            const msg = {
                type: 'chat',
                text: 'PING'
            };

            ws.send(JSON.stringify(msg));
            log(`üì§ Sent PING`, 'sent');
        }

        function sendJSON() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('‚ö†Ô∏è Not connected to server', 'error');
                return;
            }

            const msg = {
                type: 'chat',
                text: 'JSON test',
                metadata: {
                    timestamp: new Date().toISOString(),
                    client: 'Test Client',
                    version: '1.0'
                }
            };

            ws.send(JSON.stringify(msg));
            log(`üì§ Sent: ${JSON.stringify(msg, null, 2)}`, 'sent');
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            messageCount = 0;
            log('üóëÔ∏è Log cleared', 'system');
        }

        // Auto-connect on load (optional)
        // connect();

        log('‚ú® WebSocket Test Client ready!', 'system');
        log('üí° Tip: Click "Connect" to start testing', 'system');
    </script>
</body>
</html>
